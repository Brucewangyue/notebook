# OAuth2简介

[OAuth2协议官方文档](https://tools.ietf.org/html/rfc6749) 

## 名词介绍

| 名词       | 描述 |
| ---------- | ---- |
| 授权服务器 |      |



## 四种授权流程 Authorization Grant

### 1、Authorization Code

* 授权码是通过使用授权服务器作为客户端和资源所有者之间的中介来获得的。客户机没有直接向资源所有者请求授权，而是将资源所有者定向到授权服务器(根据[RFC2616]中定义的通过其用户代理)，后者反过来用授权码将资源所有者定向回客户机。

* 在使用授权码将资源所有者返回到客户机之前，授权服务器对资源所有者进行身份验证并获得授权。因为资源所有者只使用授权服务器进行身份验证，所以从不与客户机共享资源所有者的凭据。

* 授权码提供了一些重要的安全好处，例如能够对客户机进行身份验证，以及将访问令牌直接传输到客户端，而无需通过资源所有者的用户代理传递它，并可能将其暴露给其他人，包括资源所有者。


* ```
       +----------+
       | Resource |
       |   Owner  |
       |          |
       +----------+
            ^
            |
           (B)
       +----|-----+          Client Identifier      +---------------+
       |         -+----(A)-- & Redirection URI ---->|               |
       |  User-   |                                 | Authorization |
       |  Agent  -+----(B)-- User authenticates --->|     Server    |
       |          |                                 |               |
       |         -+----(C)-- Authorization Code ---<|               |
       +-|----|---+                                 +---------------+
         |    |                                         ^      v
        (A)  (C)                                        |      |
         |    |                                         |      |
         ^    v                                         |      |
       +---------+                                      |      |
       |         |>---(D)-- Authorization Code ---------'      |
       |  Client |          & Redirection URI                  |
       |         |                                             |
       |         |<---(E)----- Access Token -------------------'
       +---------+       (w/ Optional Refresh Token)
  ```
   * (A) 客户端通过将资源所有者的用户代理指向授权端点来启动流。客户端包括其客户端标识符、请求的范围、本地状态和重定向URI，一旦访问被授予(或拒绝)，授权服务器将把用户代理发送回重定向URI。
   * (B) 授权服务器(通过用户代理)对资源所有者进行身份验证，并确定资源所有者是否授予或拒绝客户端的访问请求。
   * (C) 假设资源所有者授予访问权，授权服务器使用先前提供的重定向URI将用户代理重定向回客户端(在请求中或客户端注册期间)。重定向URI包括一个授权代码和客户机之前提供的任何本地状态。
   * (D) 客户端通过包含在前一步中接收到的授权代码，从授权服务器的令牌端点请求访问令牌。当发出请求时，客户端使用授权服务器进行身份验证。客户端包含用于获取验证授权代码的重定向URI。
   * (E) 授权服务器对客户端进行身份验证，验证授权代码，并确保接收到的重定向URI与步骤(C)中用于重定向客户端的URI相匹配。如果有效，授权服务器将响应一个访问令牌和一个刷新令牌(可选)。

### 2、Implicit

* 隐式授权是一种简化的授权码流，针对在浏览器中使用JavaScript等脚本语言实现的客户端（单页面无后台系统）进行了优化。在隐式流中，不是向客户端发送授权码，而是直接向客户端发送访问令牌。授权类型是隐式的，因为没有颁发中间凭证(授权码)。

* 在隐式授权流中发送访问令牌时，授权服务器不会对客户端进行身份验证。在某些情况下，可以通过用于向客户端交付访问令牌的重定向URI验证客户端标识。访问令牌可以公开给资源所有者或其他能够访问资源所有者的用户代理的应用程序（浏览器）。

* 隐式授权提高了一些客户端(例如作为浏览器内应用程序实现的客户机)的响应能力和效率，因为它减少了获得访问令牌所需的往返次数。然而，这种便利应该与使用隐式授权带来的安全影响进行权衡，特别是在授权码授权类型可用的情况下。

* ```
       +----------+
       | Resource |
       |  Owner   |
       |          |
       +----------+
            ^
            |
           (B)
       +----|-----+          Client Identifier     +---------------+
       |         -+----(A)-- & Redirection URI --->|               |
       |  User-   |                                | Authorization |
       |  Agent  -|----(B)-- User authenticates -->|     Server    |
       |          |                                |               |
       |          |<---(C)--- Redirection URI ----<|               |
       |          |          with Access Token     +---------------+
       |          |            in Fragment
       |          |                                +---------------+
       |          |----(D)--- Redirection URI ---->|   Web-Hosted  |
       |          |          without Fragment      |     Client    |
       |          |                                |    Resource   |
       |     (F)  |<---(E)------- Script ---------<|               |
       |          |                                +---------------+
       +-|--------+
         |    |
        (A)  (G) Access Token
         |    |
         ^    v
       +---------+
       |         |
       |  Client |
       |         |
       +---------+
  ```
   * (A) 客户端通过将资源所有者的用户代理指向授权端点来启动流。客户端包括其客户端标识符、请求的范围、本地状态和重定向URI，一旦访问被授予(或拒绝)，授权服务器将把用户代理发送回重定向URI。
   * (B) 授权服务器(通过用户代理)对资源所有者进行身份验证，并确定资源所有者是否授予或拒绝客户端的访问请求。
   * (C) 假设资源所有者授予访问权，授权服务器使用前面提供的重定向URI将用户代理重定向回客户机。重定向URI在URI片段中包含访问令牌。
   * (D) 用户代理通过向web托管的客户端资源发出请求，遵循重定向指令。用户代理在本地保留片段信息。
   * (E) web托管的客户端资源返回一个web页面(典型的带有嵌入式脚本的HTML文档)，能够访问完整的重定向URI，包括由用户代理保留的片段，并提取片段中包含的访问令牌(和其他参数)。
   * (F) 用户代理执行由本地web托管的客户端资源提供的脚本，提取访问令牌。
   * (G) 用户代理将访问令牌传递给客户机。

### 3、Resource Owner Password Credentials

* 资源所有者密码凭据(即用户名和密码)可以直接用作获得访问令牌的授权授予。仅当资源所有者和客户端之间存在高度信任时(例如，客户端是设备操作系统的一部分或具有高度特权的应用程序)，以及当其他授权授予类型不可用时(例如授权代码)，才应该使用凭据。

* 尽管这种授予类型要求客户端直接访问资源所有者凭证，但资源所有者凭证用于单个请求，并交换访问令牌。通过使用长期访问令牌或刷新令牌交换凭据，这种授予类型可以消除客户端存储资源所有者凭据以供将来使用的需要。

* ```
       +----------+
       | Resource |
       |  Owner   |
       |          |
       +----------+
            v
            |    Resource Owner
           (A) Password Credentials
            |
            v
       +---------+                                  +---------------+
       |         |>--(B)---- Resource Owner ------->|               |
       |         |         Password Credentials     | Authorization |
       | Client  |                                  |     Server    |
       |         |<--(C)---- Access Token ---------<|               |
       |         |    (w/ Optional Refresh Token)   |               |
       +---------+                                  +---------------+
  ```
   * (A) 资源所有者向客户端提供用户名和密码。
   * (B) 客户端通过包含从资源所有者收到的凭据，从授权服务器的令牌端点请求访问令牌。当发出请求时，客户端使用授权服务器进行身份验证。
   * (C) 授权服务器对客户端进行身份验证，并验证资源所有者的凭证，如果有效，则发出访问令牌。

### 4、Client Credentials

* 当授权范围限于客户端控制下的受保护资源或以前与授权服务器一起安排的受保护资源时，可以将客户端凭据(或其他形式的客户端身份验证)用作授权授予。客户端凭据通常用作授权授予，当客户端代表它自己(客户端也是资源所有者)行动时，或者基于先前与授权服务器安排的授权请求访问受保护的资源时。

* ```
    +---------+                                  +---------------+
       |         |                                  |               |
       |         |>--(A)- Client Authentication --->| Authorization |
       | Client  |                                  |     Server    |
       |         |<--(B)---- Access Token ---------<|               |
       |         |                                  |               |
       +---------+                                  +---------------+
  ```



## 刷新令牌 Refresh Token

* 刷新令牌是用于获取访问令牌的凭证。授权服务器发布刷新令牌到客户端，如果当前的访问令牌变得无效或过期，可以使用刷新令牌获得一个新的访问令牌。授权服务器可以自行决定是否发出刷新令牌。如果授权服务器发出刷新令牌，那么在发出访问令牌时就会包含刷新令牌。

* 刷新令牌是表示资源所有者授予客户端的授权字符串。字符串对客户端通常是不透明的。令牌表示用于检索授权信息的标识符。与访问令牌不同，刷新令牌仅用于授权服务器，从不发送到资源服务器。



```
刷新一个过期的 Access Token

  +--------+                                           +---------------+
  |        |--(A)------- Authorization Grant --------->|               |
  |        |                                           |               |
  |        |<-(B)----------- Access Token -------------|               |
  |        |               & Refresh Token             |               |
  |        |                                           |               |
  |        |                            +----------+   |               |
  |        |--(C)---- Access Token ---->|          |   |               |
  |        |                            |          |   |               |
  |        |<-(D)- Protected Resource --| Resource |   | Authorization |
  | Client |                            |  Server  |   |     Server    |
  |        |--(E)---- Access Token ---->|          |   |               |
  |        |                            |          |   |               |
  |        |<-(F)- Invalid Token Error -|          |   |               |
  |        |                            +----------+   |               |
  |        |                                           |               |
  |        |--(G)----------- Refresh Token ----------->|               |
  |        |                                           |               |
  |        |<-(H)----------- Access Token -------------|               |
  +--------+           & Optional Refresh Token        +---------------+
```